# Changes - 2025-10-15

## Summary
Fixed three key issues based on user requirements:
1. ✅ Analysis IFC now saves in "Skiplum demo" folder within original IFC directory
2. ✅ Excel is NO LONGER saved automatically
3. ✅ Excel only generated/saved when user explicitly clicks button

---

## 🗂️ File Changes

### 1. `ifc_sync_simple.py` (Backend)

#### Analysis IFC Location Changed
- **Before**: Saved to `output/filename_analyse.ifc`
- **After**: Saved to `input/Skiplum demo/filename_analyse.ifc`

```python
# Lines 204-213: New location logic
skiplum_folder = ifc_path.parent / "Skiplum demo"
skiplum_folder.mkdir(exist_ok=True, parents=True)
analysis_path = skiplum_folder / analysis_name
```

#### Excel Save Removed from Workflow
- **Before**: `run_workflow()` always saved Excel file
- **After**: Returns DataFrame only; Excel saved on-demand

```python
# Lines 442-450: Removed automatic Excel save
df = self.extract_ifc_to_excel(ifc_path, progress_callback)
logger.info(f"✅ Extracted {len(df)} elements to DataFrame (Excel NOT saved)")
```

#### Return Value Changed
```python
# Before:
return {
    'excel': excel_path,
    'analysis_ifc': analysis_path,
    'dataframe': df
}

# After:
return {
    'analysis_ifc': analysis_path,
    'dataframe': df
}
```

#### New Method Added
- **`save_dataframe_to_excel()`** (lines 353-382)
- Purpose: Generate and save Excel on-demand
- Used by Streamlit button

---

### 2. `streamlit_dashboard.py` (Frontend)

#### Session State Cleanup
- **Removed**: `st.session_state.current_excel` (no longer needed)
- **Removed**: `load_excel_data()` function (unused)

#### File Upload Result Handling
```python
# Lines 246-250: Updated to remove Excel reference
if result:
    st.session_state.current_analysis_ifc = result['analysis_ifc']
    st.session_state.df = result['dataframe']
    st.success(f"✅ Ekstrahert {len(result['dataframe'])} elementer")
    st.info(f"📁 Analyse-IFC lagret i: {result['analysis_ifc']}")
```

#### Excel File Selector Removed
- **Removed**: Lines that listed Excel files in output folder
- **Reason**: No Excel files are auto-generated anymore

#### Export Section Updated (Lines 312-374)
**New structure:**
1. **"💾 Generer og lagre Excel"** button
   - Saves Excel to `output/` folder on disk
   - Provides file path confirmation

2. **"📥 Last ned Excel"** button
   - Downloads Excel directly (in-memory)
   - Does NOT save to disk

3. **"🏗️ Last ned Analyse-IFC"** button
   - Downloads analysis IFC from Skiplum demo folder

---

## 📁 Directory Structure (After Changes)

### When User Uploads IFC File

```
lca-flow-demo/
├── input/
│   ├── MyModel.ifc                    ← Original uploaded IFC
│   └── Skiplum demo/                  ← NEW: Auto-created folder
│       └── MyModel_analyse.ifc        ← Analysis IFC saved here
├── output/                            ← Only used if user clicks "Generate and Save Excel"
│   └── MyModel_analyse.xlsx           ← Optional: Saved on button click
├── streamlit_dashboard.py
└── ifc_sync_simple.py
```

### Key Points
- **Analysis IFC**: Always in `input/Skiplum demo/`
- **Excel**: Only created when user explicitly clicks button
- **Solibri**: Can watch `input/Skiplum demo/MyModel_analyse.ifc` for live updates

---

## 🎯 User Workflow (Updated)

### 1. Upload IFC File
```
User uploads MyModel.ifc
↓
Streamlit saves to: input/MyModel.ifc
↓
Analysis IFC created: input/Skiplum demo/MyModel_analyse.ifc
↓
DataFrame stored in memory (NO EXCEL SAVED)
```

### 2. Edit Gjenbruksstatus
```
User clicks scenario button (e.g., "Gjenbruk betongvegger")
↓
DataFrame updated in memory
↓
Analysis IFC updated directly
↓
Solibri detects change and prompts reload
```

### 3. Generate Excel (Optional)
```
User clicks "💾 Generer og lagre Excel"
↓
Excel saved to: output/MyModel_analyse.xlsx
↓
User gets confirmation message
```

OR

```
User clicks "📥 Last ned Excel"
↓
Excel generated in memory
↓
Browser downloads file (NOT saved to disk)
```

---

## ✅ Benefits of Changes

1. **Analysis IFC in "Skiplum demo" folder**
   - Cleaner organization
   - Easy to find analysis files
   - Separate from original IFC

2. **No automatic Excel generation**
   - Faster workflow (no disk I/O unless needed)
   - Reduced clutter in output folder
   - Works entirely in-memory for demo scenarios

3. **On-demand Excel save**
   - User control over when Excel is generated
   - Clear distinction between download (temporary) and save (persistent)
   - Better for demos (no files left behind)

---

## 🧪 Testing Checklist

- [ ] Upload IFC file
- [ ] Verify analysis IFC saved in `input/Skiplum demo/`
- [ ] Verify NO Excel file created automatically
- [ ] Click scenario button (e.g., "Gjenbruk betongvegger")
- [ ] Verify analysis IFC updated (check Solibri reload prompt)
- [ ] Click "💾 Generer og lagre Excel"
- [ ] Verify Excel saved to `output/` folder
- [ ] Click "📥 Last ned Excel"
- [ ] Verify Excel downloads (browser)
- [ ] Verify Excel NOT saved to disk for download button

---

## 🔍 Code References

### Backend Changes
- `ifc_sync_simple.py:204-213` - Skiplum demo folder creation
- `ifc_sync_simple.py:442-450` - Removed auto Excel save
- `ifc_sync_simple.py:474-477` - Updated return value
- `ifc_sync_simple.py:353-382` - New on-demand Excel save method

### Frontend Changes
- `streamlit_dashboard.py:84-85` - Removed current_excel session state
- `streamlit_dashboard.py:246-250` - Updated result handling (upload)
- `streamlit_dashboard.py:297-301` - Updated result handling (dev mode)
- `streamlit_dashboard.py:312-374` - New export section with buttons

---

## 📝 Notes

- Analysis IFC path is now: `input/Skiplum demo/{filename}_analyse.ifc`
- Excel files are ONLY in `output/` if user clicks "Generate and Save"
- Solibri should watch: `input/Skiplum demo/{filename}_analyse.ifc`
- All scenario buttons update analysis IFC directly (fast updates)
- DataFrame stays in memory throughout session
